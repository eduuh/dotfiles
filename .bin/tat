#!/usr/bin/env zsh
# tat - Tmux Attach to project
# Simple session manager with zoxide frecency + fzf preview

source "$HOME/.bin/tmux-lib.sh"

require_tmux
tmux_init
require_fzf

PREVIEW_SCRIPT="$HOME/.bin/tat-preview.sh"
TEMPLATE_SCRIPT="$HOME/.bin/tat-template.sh"

# Get all projects: worktree entries (repo/branch) + regular clones
get_projects() {
    local projects=()

    # Worktree entries: ~/projects/worktree/repo/branch â†’ "repo/branch"
    if [[ -d "$WORKTREE_DIR" ]]; then
        for repo_dir in "$WORKTREE_DIR"/*/(N); do
            [[ -d "$repo_dir" ]] || continue
            local repo_name=$(basename "$repo_dir")
            for branch_dir in "$repo_dir"/*/(N); do
                [[ -d "$branch_dir" ]] || continue
                local branch_name=$(basename "$branch_dir")
                projects+=("${repo_name}/${branch_name}")
            done
        done
    fi

    # Regular clones: ~/projects/*/ excluding bare/, worktree/, hidden dirs
    for dir in "$PROJECT_ROOT"/*/; do
        [[ -d "$dir" ]] || continue
        local name=$(basename "$dir")
        [[ "$name" == .* ]] && continue
        [[ "$name" == "bare" ]] && continue
        [[ "$name" == "worktree" ]] && continue
        projects+=("$name")
    done

    printf '%s\n' "${projects[@]}"
}

# Sort projects by zoxide frecency
sort_by_frecency() {
    if command -v zoxide &>/dev/null; then
        while IFS= read -r project; do
            local ppath=$(resolve_project_path "$project")
            local score=$(zoxide query -s "$ppath" 2>/dev/null | /usr/bin/awk '{print $1}')
            [[ -z "$score" ]] && score="0"
            echo "$score $project"
        done | sort -rn | /usr/bin/awk '{print $2}'
    else
        sort
    fi
}

# Check if session exists
has_session() {
    $TMUX_CMD has-session -t "=$1" 2>/dev/null
}

# Build display list with session indicators
build_list() {
    get_projects | sort_by_frecency | while IFS= read -r project; do
        if has_session "$project"; then
            echo "[*] $project"
        else
            echo "    $project"
        fi
    done
}

# Run fzf with preview
selected=$(build_list | "$FZF_CMD" \
    --reverse \
    --ansi \
    --header="Select project (preview: git status, readme)" \
    --preview="$PREVIEW_SCRIPT {-1}" \
    --preview-window="right:50%:wrap" \
    | /usr/bin/awk '{print $NF}')

# Exit if nothing selected
[[ -z "$selected" ]] && exit 0

session_name="$selected"
project_path=$(resolve_project_path "$selected")

# Create or switch to session
if has_session "$session_name"; then
    $TMUX_CMD switch-client -t "$session_name"
else
    "$TEMPLATE_SCRIPT" "$session_name" "$project_path"
fi
