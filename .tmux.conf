##### Core behaviour ###########################################################

# Allow passthrough (tmux >= 3.4, harmless if unknown)
set -gq allow-passthrough on

# Visual noise
set -g visual-activity off

# Terminal & colors
set -g default-terminal "screen-256color"        # Change to "tmux-256color" if you have that terminfo
set -as terminal-overrides ",*:RGB"              # Truecolor for all terms that support it

# Default shell (guarded)
if-shell '[ -x /bin/zsh ]' 'set-option -g default-shell /bin/zsh'

# History & scrolling
set -g history-limit 100000

# Mouse + window/pane indices
set -g mouse on
set -g renumber-windows on
set -s escape-time 0

set -g base-index 1
set-window-option -g pane-base-index 1

# How long to show pane numbers after prefix+q
set -g display-panes-time 100


##### Prefix and basic bindings ###############################################

# Change prefix from C-b -> C-Space
unbind C-b
set -g prefix C-Space

# Splits keep current path
bind v split-window -h -c "#{pane_current_path}"
bind h split-window -v -c "#{pane_current_path}"

# Paste from buffer
bind-key y paste-buffer

# Reload config
bind R source-file ~/.tmux.conf \; refresh-client \; display "Conf Reloaded!"

# Window navigation bindings
bind -r C-h select-window -t :-     # Previous window

unbind n
bind n select-window -t 1
bind e select-window -t 2
bind i select-window -t 3
bind l select-window -t 4
bind y select-window -t 5

# New window in current dir
bind w new-window -c "#{pane_current_path}"

# Rename window
bind r command-prompt -p 'Rename Window:' 'rename-window "%%"'

# Quit pane with confirm
bind-key q confirm-before -p "Quit pane @P? (y/n)" kill-pane


##### Copy mode (vi-style + system clipboard) ##################################

# Enter copy-mode
bind-key Space copy-mode

# Core vi copy-mode movement
bind-key -T copy-mode-vi v  send -X begin-selection
bind-key -T copy-mode-vi C-v send -X rectangle-toggle
bind-key -T copy-mode-vi C-u send -X halfpage-up
bind-key -T copy-mode-vi C-d send -X halfpage-down
bind-key -T copy-mode-vi g  send -X top-line
bind-key -T copy-mode-vi G  send -X bottom-line

# Search
bind-key -T copy-mode-vi / command-prompt "search-forward '%%'"
bind-key -T copy-mode-vi ? command-prompt "search-backward '%%'"
bind-key -T copy-mode-vi n send -X search-again
bind-key -T copy-mode-vi N send -X search-reverse

# Arrows in copy-mode
bind-key -T copy-mode-vi Up    send -X cursor-up
bind-key -T copy-mode-vi Down  send -X cursor-down
bind-key -T copy-mode-vi Left  send -X cursor-left
bind-key -T copy-mode-vi Right send -X cursor-right

# Platform-specific clipboard copy on y
if-shell 'uname | grep -qi darwin' \
  "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'" \
  "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# # Super fast pane movement (no prefix)
# bind -n M-n select-pane -L   # Alt+h -> left pane
# bind -n M-i select-pane -D   # Alt+j -> down pane
# bind -n M-u select-pane -U   # Alt+k -> up pane
# bind -n M-e select-pane -R   # Alt+l -> right pane

##### Fancy bindings (sessions, panes, popups) #################################

# Toggle to last session or next, then kill current; fallback to kill-session
bind-key t run-shell '(tmux switch-client -l || tmux switch-client -n) && tmux kill-session -t \"#S\" || tmux kill-session'

# Join pane from another target (horizontal)
bind-key J command-prompt -p "join pane from: " "join-pane -h -s '%%'"

# Swap panes visually
bind-key s display-panes \; command-prompt -p "pane #: " "swap-pane -t '%%'"

# Popup: attach workspace (tat)
bind C-o display-popup -E "$HOME/.bin/tat.sh"

# Popup: restart work apps (guard these scripts yourself as needed)
bind p display-popup -E "$HOME/projects/work/script/restart-app people"
bind f display-popup -E "$HOME/projects/work/script/restart-app 'File Search'"


##### Theme & status line ######################################################

# Colors
set -gq @color_status_text "colour245"
set -gq @color_window_off_status_bg "colour238"
set -gq @color_light "white"
set -gq @color_dark "colour232"
set -gq @color_window_off_status_current_bg "colour254"

set -g status-style "bg=default,fg=#{@color_light}"
set -g window-status-current-style "bg=default,fg=magenta"
set -g pane-border-style "fg=#{@color_light}"
set -g pane-active-border-style "fg=#{@color_status_text},bg=default"
set -g mode-style "fg=#{@color_light},bold"

set -g status-interval 60
set -g status-left-length 30

# Git branch in status-left (safe if script missing)
set -g status-left '#[fg=green]#([ -x "$HOME/.bin/tmux-git-branch.sh" ] && "$HOME/.bin/tmux-git-branch.sh" #{pane_current_path}) #[default]'

# Indicator for "keys off" mode
set -gq @color_window_off_indicator "colour196"

# Status-right (guard acpi so it doesn't spam errors if missing)
set-option -g status-right "#(hostname) #[fg=red,bold]@#[fg=cyan] -> #[fg=blue,bold]#S#[default] #[fg=magenta]%R %h-%d #(command -v acpi >/dev/null 2>&1 && acpi | cut -d ',' -f2)"

# Window/pane title
set-option -g set-titles on
set-option -g set-titles-string '#H:#S.#I.#P #W #T'


##### Keys-off mode toggle #####################################################

bind k \
  set prefix None \; \
  set key-table off \; \
  set status-style "fg=#{@color_status_text},bg=#{@color_window_off_status_bg}" \; \
  set window-status-current-format "#[fg=#{@color_window_off_status_bg},bg=#{@color_window_off_status_current_bg}]$separator_powerline_right#[default] #I:#W# #[fg=#{@color_window_off_status_current_bg},bg=#{@color_window_off_status_bg}]$separator_powerline_right#[default]" \; \
  set window-status-current-style "fg=#{@color_dark},bold,bg=#{@color_window_off_status_current_bg}" \; \
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \; \
  refresh-client -S

bind -T off k \
  set -u prefix \; \
  set -u key-table \; \
  set -u status-style \; \
  set -u window-status-current-style \; \
  set -u window-status-current-format \; \
  refresh-client -S


##### Plugins ##################################################################

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @continuum-restore 'on'
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-save-interval '15'

run-shell '~/.tmux/plugins/tpm/tpm'
